name: Auto PR on feature pushes

on:
  push:
    branches:
      - "feature/**"

permissions:
  contents: read
  pull-requests: write

jobs:
  open-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up GitHub CLI
        run: |
          gh --version

      - name: Create or update PR
        env:
          GH_TOKEN: ${{ secrets.PAT }} # or use secrets.PAT with repo scope
        run: |
          BASE="dev"  # <- change to your real base (e.g., develop)
          HEAD="${GITHUB_REF_NAME}"
          TITLE="Automated PR for ${HEAD}"
          BODY="This PR was auto-generated from changes on branch **${HEAD}**."

          # Try to find existing open PR from HEAD -> BASE
          set -e
          PR_NUMBER=$(gh pr list --state open --head "${HEAD}" --base "${BASE}" --json number --jq '.[0].number' || true)

          if [ -n "$PR_NUMBER" ]; then
            echo "PR #$PR_NUMBER already exists. Updating title/body."
            gh pr edit "$PR_NUMBER" --title "$TITLE" --body "$BODY"
          else
            echo "Creating new PR from ${HEAD} to ${BASE}"
            gh pr create --base "$BASE" --head "$HEAD" --title "$TITLE" --body "$BODY" --draft=false
          fi

      - name: Assign reviewers
        if: success()
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          BASE="dev"
          HEAD="${GITHUB_REF_NAME}"
          PR_NUMBER=$(gh pr list --state open --head "${HEAD}" --base "${BASE}" --json number --jq '.[0].number')
          gh pr edit "$PR_NUMBER" --add-reviewer FroCode
          gh pr comment "$PR_NUMBER" --body "Ready for review! Assigned reviewers: @FroCode"